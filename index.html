<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Avidware</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      background:#020617; color:#e5e7eb; font-family:Arial;
      display:flex; justify-content:center; align-items:center; height:100vh;
    }
    .card {
      background:#0f172a; padding:20px; border-radius:12px; width:340px;
    }
    input, button {
      width:100%; margin-top:10px; padding:10px;
      border-radius:8px; border:none;
    }
    input {
      background:#020617; color:#fff; border:1px solid #334155;
    }
    button {
      background:#2563eb; color:#fff; cursor:pointer;
    }
    hr { margin:15px 0; border-color:#334155 }
    .hidden { display:none }
  </style>
</head>
<body>

<div class="card">
  <h2>Login</h2>
  <input id="loginEmail" placeholder="Email">
  <input id="loginPassword" type="password" placeholder="Password">
  <button id="loginBtn">Login</button>

  <hr>

  <h2>Register</h2>
  <input id="username" placeholder="Username">
  <input id="regEmail" placeholder="Email">
  <input id="regPassword" type="password" placeholder="Password">
  <input id="invite" placeholder="Invite code" class="hidden">
  <button id="registerBtn">Register</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getAuth,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {
  getFirestore,
  doc,
  getDoc,
  setDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* ===== FIREBASE CONFIG ===== */
const firebaseConfig = {
  apiKey: "AIzaSyCIXJyovY1P0fvoEexAApCesqiTphA_mTk",
  authDomain: "avidware.firebaseapp.com",
  projectId: "avidware",
  storageBucket: "avidware.firebasestorage.app",
  messagingSenderId: "1003506881786",
  appId: "1:1003506881786:web:8c64d2aaf477fdf009e543"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ===== INVITE CONFIG ===== */
let invitesEnabled = false;

try {
  const cfg = await getDoc(doc(db, "config", "site"));
  if (cfg.exists() && cfg.data().invitesEnabled === true) {
    invitesEnabled = true;
    document.getElementById("invite").classList.remove("hidden");
  }
} catch (e) {
  console.warn("Config not found, invites OFF");
}

/* ===== LOGIN ===== */
document.getElementById("loginBtn").addEventListener("click", async () => {
  try {
    await signInWithEmailAndPassword(
      auth,
      loginEmail.value,
      loginPassword.value
    );
    location.href = "forum.html";
  } catch (e) {
    alert(e.message);
  }
});

/* ===== REGISTER ===== */
document.getElementById("registerBtn").addEventListener("click", async () => {
  try {
    const username = document.getElementById("username").value.trim();
    const email = regEmail.value;
    const pass = regPassword.value;

    if (!/^[a-zA-Z0-9_]{3,20}$/.test(username)) {
      alert("Username: a-z A-Z 0-9 _ (3â€“20)");
      return;
    }

    let inviteRef = null;

    if (invitesEnabled) {
      const code = invite.value.trim();
      inviteRef = doc(db, "invites", code);
      const snap = await getDoc(inviteRef);

      if (!snap.exists() || snap.data().used) {
        alert("Invalid invite");
        return;
      }
    }

    const cred = await createUserWithEmailAndPassword(auth, email, pass);

    await setDoc(doc(db, "users", cred.user.uid), {
      username,
      email,
      role: "user",
      createdAt: Date.now()
    });

    if (invitesEnabled && inviteRef) {
      await setDoc(inviteRef, {
        ...(await getDoc(inviteRef)).data(),
        used: true,
        usedBy: cred.user.uid
      });
    }

    location.href = "forum.html";
  } catch (e) {
    alert(e.message);
  }
});
</script>

</body>
</html>
