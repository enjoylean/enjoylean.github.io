<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Avidware</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { background:#0f172a; color:#e5e7eb; font-family:Arial; display:flex; justify-content:center; align-items:center; height:100vh }
    .box { background:#020617; padding:24px; border-radius:12px; width:360px }
    input,button { width:100%; padding:10px; margin-top:10px; border-radius:8px; border:none }
    input { background:#020617; color:#fff; border:1px solid #334155 }
    button { background:#2563eb; color:#fff; cursor:pointer }
    .msg { margin-top:10px; text-align:center }
  </style>
</head>
<body>

<div class="box">
  <h2>reg—É</h2>
  <input id="username" placeholder="Username" />
  <input id="email" placeholder="Email" />
  <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å" />
  <input id="invite" placeholder="Invite code" />
  <button onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
  <div class="msg" id="msg"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, query, where, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCIXJyovY1P0fvoEexAApCesqiTphA_mTk",
  authDomain: "avidware.firebaseapp.com",
  projectId: "avidware",
  storageBucket: "avidware.firebasestorage.app",
  messagingSenderId: "1003506881786",
  appId: "1:1003506881786:web:8c64d2aaf477fdf009e543"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const msg = document.getElementById("msg");

window.register = async () => {
  try {
    const username = document.getElementById("username").value.trim();
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;
    const inviteCode = document.getElementById("invite").value.trim();

    if (!username || !email || !password || !inviteCode) {
      msg.innerText = "–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è";
      return;
    }

    // –ø—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ username
    const q = query(collection(db, "users"), where("username", "==", username));
    const snap = await getDocs(q);
    if (!snap.empty) {
      msg.innerText = "Username —É–∂–µ –∑–∞–Ω—è—Ç";
      return;
    }

    // –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–≤–∞–π—Ç–∞
    const inviteRef = doc(db, "invites", inviteCode);
    const inviteSnap = await getDoc(inviteRef);

    if (!inviteSnap.exists() || inviteSnap.data().used) {
      msg.innerText = "–ò–Ω–≤–∞–π—Ç –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω";
      return;
    }

    // —Å–æ–∑–¥–∞—ë–º –∞–∫–∫–∞—É–Ω—Ç
    const cred = await createUserWithEmailAndPassword(auth, email, password);

    // –ø—Ä–æ—Ñ–∏–ª—å
    await setDoc(doc(db, "users", cred.user.uid), {
      email,
      username,
      role: "user",
      bio: "",
      avatar: "",
      createdAt: Date.now()
    });

    // –ø–æ–º–µ—á–∞–µ–º –∏–Ω–≤–∞–π—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–º
    await updateDoc(inviteRef, {
      used: true,
      usedBy: cred.user.uid
    });

    msg.innerText = "–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω üéâ";
  } catch (e) {
    msg.innerText = e.message;
  }
};
</script>

</body>
</html>

