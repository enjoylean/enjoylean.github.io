<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Avidware ‚Äì Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { background:#020617; color:#e5e7eb; font-family:Arial; display:flex; justify-content:center; align-items:center; height:100vh }
    .card { background:#0f172a; padding:20px; border-radius:12px; width:320px }
    input, button { width:100%; margin-top:10px; padding:10px; border-radius:8px; border:none }
    input { background:#020617; color:#fff; border:1px solid #334155 }
    button { background:#2563eb; color:#fff; cursor:pointer }
    .hidden { display:none }
  </style>
</head>
<body>

<div class="card">
  <h2>Login</h2>
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button onclick="login()">Login</button>

  <hr style="margin:15px 0">

  <h2>Register</h2>
  <input id="username" placeholder="Username">
  <input id="regEmail" placeholder="Email">
  <input id="regPassword" type="password" placeholder="Password">
  <input id="invite" placeholder="Invite code" class="hidden">
  <button onclick="register()">Register</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCIXJyovY1P0fvoEexAApCesqiTphA_mTk",
  authDomain: "avidware.firebaseapp.com",
  projectId: "avidware",
  storageBucket: "avidware.firebasestorage.app",
  messagingSenderId: "1003506881786",
  appId: "1:1003506881786:web:8c64d2aaf477fdf009e543"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let invitesEnabled = false;

// üî• –ó–ê–ì–†–£–ó–ö–ê –ö–û–ù–§–ò–ì–ê
const cfgSnap = await getDoc(doc(db, "config", "site"));
if (cfgSnap.exists() && cfgSnap.data().invitesEnabled === true) {
  invitesEnabled = true;
  document.getElementById("invite").classList.remove("hidden");
}

// LOGIN
window.login = async () => {
  await signInWithEmailAndPassword(auth, email.value, password.value);
  location.href = "forum.html";
};

// REGISTER
window.register = async () => {
  const username = document.getElementById("username").value.trim();
  const mail = regEmail.value;
  const pass = regPassword.value;

  if (!/^[a-zA-Z0-9_]{3,20}$/.test(username)) {
    alert("Invalid username");
    return;
  }

  // üîê INVITE CHECK
  if (invitesEnabled) {
    const code = invite.value.trim();
    const inviteRef = doc(db, "invites", code);
    const snap = await getDoc(inviteRef);

    if (!snap.exists() || snap.data().used) {
      alert("Invalid invite");
      return;
    }

    const cred = await createUserWithEmailAndPassword(auth, mail, pass);

    await setDoc(doc(db, "users", cred.user.uid), {
      username,
      email: mail,
      role: "user",
      createdAt: Date.now()
    });

    await setDoc(inviteRef, {
      ...snap.data(),
      used: true,
      usedBy: cred.user.uid
    });

    location.href = "forum.html";
    return;
  }

  // ‚ùå INVITES OFF
  const cred = await createUserWithEmailAndPassword(auth, mail, pass);
  await setDoc(doc(db, "users", cred.user.uid), {
    username,
    email: mail,
    role: "user",
    createdAt: Date.now()
  });

  location.href = "forum.html";
};
</script>

</body>
</html>
