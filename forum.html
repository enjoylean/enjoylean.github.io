<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Avidware</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Lexend+Giga:wght@700&display=swap" rel="stylesheet">
  <style>
    body {
      background:#0a0415; color:#e5e7eb; font-family:Inter, Arial, sans-serif;
      display:flex; justify-content:center; align-items:center; height:100vh;
      margin:0; overflow:hidden;
    }

    /* splash / logo */
    .splash {
      position:fixed; inset:0;
      background:linear-gradient(135deg, #0a0415 0%, #1a0033 100%);
      display:flex; justify-content:center; align-items:center;
      z-index:9999; pointer-events:none;
      animation:splashFade 3.6s ease-in-out forwards;
    }

    @keyframes splashFade { 0%{opacity:1} 60%{opacity:1} 100%{opacity:0} }

    .logo-text { font-size:56px; font-weight:700; letter-spacing:6px; display:flex; gap:6px; font-family:'Lexend Giga', sans-serif; }
    .logo-char { background:linear-gradient(90deg,#fff 0%,#e9ddff 50%,#9d4edd 100%); -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent; text-shadow:0 0 28px rgba(157,78,221,0.8); transform:translateY(36px); opacity:0; animation:charSlideIn .56s cubic-bezier(.2,.9,.2,1) forwards; }

    @keyframes charSlideIn { from{opacity:0; transform:translateY(36px)} to{opacity:1; transform:translateY(0)} }
    .logo-char:nth-child(1){animation-delay:.08s} .logo-char:nth-child(2){animation-delay:.16s} .logo-char:nth-child(3){animation-delay:.24s}
    .logo-char:nth-child(4){animation-delay:.32s} .logo-char:nth-child(5){animation-delay:.40s} .logo-char:nth-child(6){animation-delay:.48s}
    .logo-char:nth-child(7){animation-delay:.56s} .logo-char:nth-child(8){animation-delay:.64s} .logo-char:nth-child(9){animation-delay:.72s}
    .logo-char:nth-child(10){animation-delay:.80s} .logo-char:nth-child(11){animation-delay:.88s} .logo-char:nth-child(12){animation-delay:.96s}
    .logo-char:nth-child(13){animation-delay:1.04s}

    /* card + ambient glow */
    .card { position:relative; background:rgba(15,23,42,0.6); padding:22px; border-radius:14px; width:360px; color:var(--fg,#e5e7eb); backdrop-filter:blur(6px) saturate(1.1); box-shadow: 0 10px 30px rgba(10,2,30,0.6); transform:translateY(0); opacity:0; animation:cardAppear .6s ease-in .9s forwards; }
    .card::before { content:""; position:absolute; inset:-40px; background:radial-gradient(closest-side, rgba(157,78,221,0.18), transparent 40%); filter:blur(30px); z-index:-1; pointer-events:none; border-radius:18px; }

    @keyframes cardAppear { from{opacity:0; transform:translateY(12px)} to{opacity:1; transform:translateY(0)} }

    .tabs { display:flex; gap:10px; margin-bottom:18px; }
    .tab-btn { flex:1; padding:10px; border-radius:999px; border:none; background:transparent; color:#cbd5e1; cursor:pointer; transition:all .28s; font-weight:600 }
    .tab-btn.active { background:linear-gradient(90deg,#2b3650,#1f2a44); color:#fff; box-shadow:0 6px 16px rgba(45,40,80,0.25) }

    .form-section { display:none; opacity:0; transform:translateY(12px); transition:opacity .28s, transform .28s }
    .form-section.active { display:block; opacity:1; transform:translateY(0) }

    .info-text { font-size:13px; color:#bfc9db; margin-top:12px; padding:10px 12px; background:linear-gradient(90deg, rgba(10,4,21,0.4), rgba(10,4,21,0.2)); border-radius:10px; border-left:3px solid rgba(157,78,221,0.7) }

    input, button { width:100%; margin-top:10px; padding:12px 14px; border-radius:10px; box-sizing:border-box }
    input { background:rgba(2,6,23,0.55); color:#fff; border:1px solid rgba(115,125,150,0.12); transition:box-shadow .18s, border-color .18s, transform .18s }
    input:focus { outline:none; border-color:rgba(157,78,221,0.8); box-shadow:0 6px 18px rgba(157,78,221,0.12); transform:translateY(-2px) }

    button { background:linear-gradient(90deg,#8b63ff,#5b21b6); color:#fff; border:none; font-weight:700; cursor:pointer; transition:transform .12s ease, box-shadow .12s }
    button:active { transform:translateY(1px) }
    button:hover { box-shadow:0 12px 30px rgba(92,33,182,0.18) }

    .hidden{display:none}
  </style>
</head>
<body>

<div class="splash">
  <div class="logo-text" id="logoText"></div>
</div>

<div class="card">
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('login', this)">Login</button>
    <button class="tab-btn" onclick="switchTab('register', this)">Register</button>
  </div>

  <div id="login" class="form-section active">
    <h2>Login</h2>
    <input id="loginEmail" placeholder="Email">
    <input id="loginPassword" type="password" placeholder="Password">
    <button onclick="doLogin()">Login</button>
  </div>

  <div id="register" class="form-section">
    <h2>Register</h2>
    <input id="username" placeholder="Username">
    <input id="regEmail" placeholder="Email">
    <input id="regPassword" type="password" placeholder="Password">
    <input id="invite" placeholder="Invite code" class="hidden">
    <button onclick="doRegister()">Register</button>
    <div class="info-text">
      üí° Get invite: <a href="https://t.me/avidware" target="_blank" style="color:#93c5fd; text-decoration:none;">t.me/avidware</a>
    </div>
  </div>
</div>

<script type="module">
// ===== –ê–ù–ò–ú–ê–¶–ò–Ø –ë–£–ö–í =====
const text = "avidware.fun";
const logoEl = document.getElementById("logoText");
text.split("").forEach(char => {
  const span = document.createElement("span");
  span.className = "logo-char";
  span.textContent = char;
  logoEl.appendChild(span);
});

// ===== –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –¢–ê–ë–û–í =====
window.switchTab = function(tab, btn) {
  document.querySelectorAll(".form-section").forEach(el => el.classList.remove("active"));
  document.querySelectorAll(".tab-btn").forEach(el => el.classList.remove("active"));
  document.getElementById(tab).classList.add("active");
  if (btn) btn.classList.add('active');
};

// display debug/error info in UI (declared before handlers)
function showError(msg, err) {
  console.warn(msg, err || '');
  let el = document.getElementById('debugError');
  if (!el) {
    el = document.createElement('div');
    el.id = 'debugError';
    el.style.cssText = 'margin-top:12px;padding:10px;border-radius:10px;background:rgba(255,50,50,0.06);color:#ffdede;font-size:13px;word-break:break-word;';
    const container = document.querySelector('.card') || document.body;
    container.appendChild(el);
  }
  el.innerText = msg;
  if (err) {
    const json = JSON.stringify(err, Object.getOwnPropertyNames(err), 2);
    let pre = document.getElementById('debugErrStack');
    if (!pre) {
      pre = document.createElement('pre');
      pre.id = 'debugErrStack';
      pre.style.cssText = 'margin-top:8px;color:#ffdede;opacity:0.95;white-space:pre-wrap;font-size:12px;background:rgba(0,0,0,0.12);padding:8px;border-radius:8px;';
      const container = document.querySelector('.card') || document.body;
      container.appendChild(pre);
    }
    pre.innerText = json;
  }
}

// ===== FIREBASE –ò–ú–ü–û–†–¢–´ =====
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// ===== FIREBASE CONFIG =====
const firebaseConfig = {
  apiKey: "AIzaSyCIXJyovY1P0fvoEexAApCesqiTphA_mTk",
  authDomain: "avidware.firebaseapp.com",
  projectId: "avidware",
  storageBucket: "avidware.firebasestorage.app",
  messagingSenderId: "1003506881786",
  appId: "1:1003506881786:web:8c64d2aaf477fdf009e543"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ===== INVITE CONFIG =====
let invitesEnabled = false;

const cfgSnap = await getDoc(doc(db, "config", "site"));
if (cfgSnap.exists() && cfgSnap.data().invitesEnabled === true) {
  invitesEnabled = true;
  document.getElementById("invite").classList.remove("hidden");
}

// ===== LOGIN =====
window.doLogin = async () => {
  try {
    await signInWithEmailAndPassword(auth, document.getElementById("loginEmail").value, document.getElementById("loginPassword").value);
    location.href = "forum.html";
  } catch (e) {
    console.error('Login error:', e);
    alert("Login error: " + e.message);
  }
};

// ===== REGISTER =====
window.doRegister = async () => {
  try {
    const username = document.getElementById("username").value.trim();
    const mail = document.getElementById("regEmail").value;
    const pass = document.getElementById("regPassword").value;

    if (!/^[a-zA-Z0-9_]{3,20}$/.test(username)) {
      alert("Invalid username (3-20 chars: a-z A-Z 0-9 _)");
      return;
    }

    // üîê INVITE CHECK
    if (invitesEnabled) {
      const code = document.getElementById("invite").value.trim();
      const inviteRef = doc(db, "invites", code);
      const snap = await getDoc(inviteRef);

      if (!snap.exists() || snap.data().used) {
        alert("Invalid invite");
        return;
      }

      const cred = await createUserWithEmailAndPassword(auth, mail, pass);

      await setDoc(doc(db, "users", cred.user.uid), {
        username,
        email: mail,
        role: "user",
        createdAt: Date.now()
      });

      await setDoc(inviteRef, {
        ...snap.data(),
        used: true,
        usedBy: cred.user.uid
      });

      location.href = "forum.html";
      return;
    }

    // ‚ùå INVITES OFF
    const cred = await createUserWithEmailAndPassword(auth, mail, pass);
    await setDoc(doc(db, "users", cred.user.uid), {
      username,
      email: mail,
      role: "user",
      createdAt: Date.now()
    });

    location.href = "forum.html";
  } catch (e) {
    console.error('Register error:', e);
    alert("Register error: " + e.message);
  }
};
</script>

</body>
</html>
