<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Avidware Forum</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Lexend+Giga:wght@700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #0a0415;
      color: #e5e7eb;
      font-family: Inter, Arial, sans-serif;
      min-height: 100vh;
    }

    /* TOP NAV */
    .navbar {
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid rgba(157, 78, 221, 0.2);
      padding: 12px 24px;
      display: flex;
      gap: 20px;
      align-items: center;
    }
    .navbar a, .navbar button {
      color: #cbd5e1;
      text-decoration: none;
      cursor: pointer;
      background: none;
      border: none;
      font-size: 14px;
      transition: color 0.2s;
    }
    .navbar a:hover, .navbar button:hover { color: #fff; }
    .navbar .user-info { margin-left: auto; font-size: 13px; }
    .navbar button { color: #ef4444; }

    /* CONTAINER */
    .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }

    /* TABS */
    .tabs { display: flex; gap: 12px; margin-bottom: 20px; }
    .tab-btn { padding: 8px 16px; border-radius: 6px; border: none; background: transparent; color: #cbd5e1; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s; }
    .tab-btn.active { background: linear-gradient(90deg, #8b63ff, #5b21b6); color: #fff; }

    /* FORUM CATEGORY */
    .forum-category {
      background: rgba(15, 23, 42, 0.6);
      margin-bottom: 20px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid rgba(157, 78, 221, 0.1);
      backdrop-filter: blur(4px);
    }

    .category-header {
      background: linear-gradient(90deg, #8b63ff, #5b21b6);
      color: #fff;
      padding: 12px 16px;
      font-size: 14px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .topic-list { display: flex; flex-direction: column; }

    .topic {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border-top: 1px solid rgba(157, 78, 221, 0.1);
      transition: background 0.2s;
      cursor: pointer;
    }
    .topic:hover { background: rgba(157, 78, 221, 0.08); }

    .topic-left { flex: 1; }
    .topic-left { flex: 1; display:flex; gap:12px; align-items:center; }
    .topic-avatar { width:48px; height:48px; border-radius:8px; object-fit:cover; background:rgba(255,255,255,0.03); border:1px solid rgba(115,125,150,0.06) }
    .topic-title { color: #93c5fd; font-weight: 600; margin-bottom: 4px; }
    .topic-meta { color: #94a3b8; font-size: 12px; }

    .topic-right { text-align: right; font-size: 12px; color: #cbd5e1; }
    .topic-replies { color: #93c5fd; font-weight: 600; }
    .topic-date { color: #64748b; margin-top: 4px; }

    /* CREATE POST FORM */
    .create-post-section {
      background: rgba(15, 23, 42, 0.6);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
      border: 1px solid rgba(157, 78, 221, 0.1);
      backdrop-filter: blur(4px);
    }

    .section-title {
      font-size: 14px;
      font-weight: 700;
      color: #cbd5e1;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
    }

    input, textarea {
      width: 100%;
      margin-bottom: 10px;
      padding: 10px 12px;
      border-radius: 6px;
      background: rgba(2, 6, 23, 0.55);
      color: #fff;
      border: 1px solid rgba(115, 125, 150, 0.12);
      font-family: Inter, Arial, sans-serif;
    }
    input:focus, textarea:focus { outline: none; border-color: rgba(157, 78, 221, 0.8); }
    textarea { min-height: 80px; resize: vertical; }

    button { 
      padding: 10px 16px;
      background: linear-gradient(90deg, #8b63ff, #5b21b6);
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: box-shadow 0.2s;
    }
    button:hover { box-shadow: 0 6px 16px rgba(92, 33, 182, 0.3); }

    /* THREAD VIEW */
    .thread-view { display: none; }
    .thread-view.active { display: block; }

    .thread-header {
      background: rgba(15, 23, 42, 0.6);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      border: 1px solid rgba(157, 78, 221, 0.1);
    }

    .thread-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
    .thread-meta { font-size: 12px; color: #94a3b8; margin-bottom: 12px; }
    .thread-back { color: #93c5fd; cursor: pointer; text-decoration: underline; font-size: 12px; }
    
    .original-post {
      background: rgba(10, 4, 21, 0.4);
      padding: 12px;
      margin-bottom: 12px;
      border-radius: 6px;
      border-left: 3px solid rgba(157, 78, 221, 0.5);
    }

    .admin-controls {
      display: flex;
      gap: 6px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .admin-btn {
      padding: 6px 12px;
      font-size: 11px;
      background: rgba(157, 78, 221, 0.3);
      color: #93c5fd;
      border: 1px solid rgba(157, 78, 221, 0.5);
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .admin-btn:hover { background: rgba(157, 78, 221, 0.5); }

    .admin-btn.danger { background: rgba(239, 68, 68, 0.2); color: #fca5a5; border-color: rgba(239, 68, 68, 0.5); }
    .admin-btn.danger:hover { background: rgba(239, 68, 68, 0.3); }

    .replies-container {
      background: rgba(15, 23, 42, 0.6);
      border-radius: 8px;
      padding: 16px;
      border: 1px solid rgba(157, 78, 221, 0.1);
      margin-bottom: 16px;
    }

    .reply-item {
      background: rgba(10, 4, 21, 0.4);
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 6px;
      border-left: 3px solid rgba(157, 78, 221, 0.5);
    }

    .reply-avatar { width:36px; height:36px; border-radius:8px; object-fit:cover; margin-right:8px; background:rgba(255,255,255,0.03); border:1px solid rgba(115,125,150,0.06) }

    .reply-author { color: #93c5fd; font-weight: 600; font-size: 12px; margin-bottom: 4px; }
    .reply-date { color: #64748b; font-size: 11px; margin-bottom: 6px; }
    .reply-text { color: #cbd5e1; font-size: 13px; }

    .reply-form {
      background: rgba(15, 23, 42, 0.6);
      border-radius: 8px;
      padding: 16px;
      border: 1px solid rgba(157, 78, 221, 0.1);
    }

    .reply-form-title { font-size: 12px; font-weight: 700; text-transform: uppercase; margin-bottom: 12px; }
    .reply-input-group { display: flex; gap: 8px; }
    .reply-input-group input { flex: 1; }

    /* CHAT */
    .chat-box {
      background: rgba(15, 23, 42, 0.6);
      border-radius: 8px;
      padding: 16px;
      border: 1px solid rgba(157, 78, 221, 0.1);
      height: 500px;
      display: flex;
      flex-direction: column;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .chat-message {
      background: rgba(10, 4, 21, 0.4);
      padding: 8px 12px;
      border-radius: 6px;
      border-left: 2px solid rgba(157, 78, 221, 0.5);
      font-size: 12px;
    }

    .chat-message-author { color: #93c5fd; font-weight: 600; font-size: 11px; }
    .chat-message-text { color: #cbd5e1; margin-top: 2px; }

    .chat-input-group { display: flex; gap: 8px; }
    .chat-input-group input { flex: 1; }

    @media (max-width: 768px) {
      .topic { flex-direction: column; align-items: flex-start; }
      .topic-right { margin-top: 8px; }
    }
    /* Wheel & pointer animations */
    #wheel { transform-origin: 50% 50%; will-change: transform; }
    #wheel.spinning { box-shadow: 0 12px 40px rgba(92,33,182,0.35), inset 0 -6px 40px rgba(0,0,0,0.6); animation: wheelGlow 0.8s infinite alternate; }
    @keyframes wheelGlow { from { filter: drop-shadow(0 6px 12px rgba(99,102,241,0.06)); } to { filter: drop-shadow(0 20px 40px rgba(99,102,241,0.14)); } }
    #pointer { transform-origin: center top; }
    #pointer.spin-pointer { animation: pointerWobble 0.12s infinite linear; }
    @keyframes pointerWobble { 0% { transform: translateY(-6px) rotate(-6deg); } 50% { transform: translateY(-6px) rotate(6deg); } 100% { transform: translateY(-6px) rotate(-6deg); } }
  </style>
</head>
<body>

<!-- NAVBAR -->
<div class="navbar">
  <a href="index.html">Index</a>
  <a href="#">Search</a>
  <a href="profile.html">Profile</a>
  <a href="#">PM</a>
  <div class="user-info">
    Logged in as: <span id="currentUser">User</span>
    <span id="coinBal" style="margin-left:12px; font-weight:700; color:#fef08a">0 ‚ß´</span>
    <button style="margin-left:10px; color:#10b981;" onclick="claimDaily()" id="dailyBtn">Daily</button>
  </div>
  <button onclick="logout()">Logout</button>
</div>

<div class="container">
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('forum')">Forum</button>
    <button class="tab-btn" onclick="switchTab('chat')">Chat</button>
    <button class="tab-btn" onclick="switchTab('shop')">Shop</button>
    <button class="tab-btn" onclick="switchTab('casino')">Casino</button>
  </div>

  <!-- FORUM TAB -->
  <div id="forum-tab" class="tab-content">
    <!-- CREATE POST -->
    <div class="create-post-section">
      <div class="section-title">Create New Topic</div>
      <input id="postTitle" placeholder="Topic title...">
      <textarea id="postContent" placeholder="Write your message..."></textarea>
      <button onclick="publishPost()">Create Topic</button>
    </div>

    <!-- FORUM CATEGORIES -->
    <div class="forum-category">
      <div class="category-header">General Discussion</div>
      <div class="topic-list" id="topicsList"></div>
    </div>
  </div>

  <!-- THREAD VIEW -->
  <div id="thread-view" class="thread-view">
    <div class="thread-header">
      <div class="thread-back" onclick="backToForum()">‚Üê Back to Forum</div>
      <div class="thread-title" id="threadTitle"></div>
      <div class="thread-meta" id="threadMeta"></div>
      <div id="threadStatus" style="margin-top: 8px; font-size: 11px; color: #fca5a5;"></div>
    </div>

    <div class="original-post" id="originalPost"></div>

    <div class="replies-container" id="repliesContainer"></div>

    <div class="reply-form">
      <div class="reply-form-title">Write a Reply</div>
      <div class="reply-input-group">
        <input id="replyInput" placeholder="Write your reply...">
        <button onclick="publishReply()">Post Reply</button>
      </div>
    </div>
  </div>

  <!-- CHAT TAB -->
  <div id="chat-tab" class="tab-content" style="display: none;">
    <div class="chat-box">
      <div class="section-title" style="margin-bottom: 12px;">üí¨ Live Chat</div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input-group">
        <input id="chatInput" placeholder="Type a message...">
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>

  <!-- SHOP TAB -->
  <div id="shop-tab" class="tab-content" style="display: none;">
    <div class="create-post-section">
      <div class="section-title">Create Listing</div>
      <input id="itemTitle" placeholder="Item title...">
      <textarea id="itemDesc" placeholder="Description..."></textarea>
      <input id="itemPrice" placeholder="Price (avidcoin)...">
      <button onclick="createListing()">Create Listing</button>
    </div>
    <div class="forum-category">
      <div class="category-header">Marketplace</div>
      <div class="topic-list" id="shopList"></div>
    </div>
  </div>

  <!-- CASINO TAB (NEW DESIGN) -->
  <div id="casino-tab" class="tab-content" style="display:none;">
    <div style="display:flex; gap:40px; align-items:flex-start; padding:20px;">
      <!-- LEFT PANEL: BET CONTROLS -->
      <div style="flex:0 0 320px;">
        <div style="background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(157, 78, 221, 0.1); border-radius: 8px; padding: 16px; backdrop-filter: blur(4px);">
          <div style="font-size: 12px; font-weight: 700; color: #cbd5e1; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;">Bet Amount</div>
          <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 12px;">
            <span style="color: #fef08a; font-weight: 700;">‚ß´</span>
            <input id="betAmount" type="number" min="1" max="10000" value="10" style="flex:1; padding: 8px; background: rgba(2, 6, 23, 0.55); border: 1px solid rgba(115, 125, 150, 0.12); border-radius: 6px; color: #fff;" onchange="updateCasinoDisplay()">
          </div>
          <input id="betSlider" type="range" min="1" max="1000" value="10" style="width: 100%; cursor: pointer; margin-bottom: 12px;" oninput="document.getElementById('betAmount').value = this.value; updateCasinoDisplay()">
          <div style="display: flex; gap: 8px; font-size: 11px; color: #94a3b8; margin-bottom: 16px;">
            <button style="flex:1; padding: 6px; background: rgba(157, 78, 221, 0.2); border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 4px; color: #cbd5e1; cursor: pointer;" onclick="document.getElementById('betAmount').value = 10; document.getElementById('betSlider').value = 10; updateCasinoDisplay()">1/2</button>
            <button style="flex:1; padding: 6px; background: rgba(157, 78, 221, 0.2); border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 4px; color: #cbd5e1; cursor: pointer;" onclick="document.getElementById('betAmount').value = 50; document.getElementById('betSlider').value = 50; updateCasinoDisplay()">x2</button>
            <button style="flex:1; padding: 6px; background: rgba(157, 78, 221, 0.2); border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 4px; color: #cbd5e1; cursor: pointer;" onclick="document.getElementById('betAmount').value = 100; document.getElementById('betSlider').value = 100; updateCasinoDisplay()">Max</button>
          </div>
          <div style="font-size: 12px; font-weight: 700; color: #cbd5e1; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Multiplier</div>
          <div style="font-size: 24px; font-weight: 700; color: #fef08a; margin-bottom: 16px;" id="multDisplay">x1.20</div>
          <button id="spinBtn" style="width: 100%; padding: 12px; background: linear-gradient(90deg, #10b981, #059669); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 14px;" onclick="spinCasino()">Spin</button>
        </div>
      </div>

      <!-- CENTER: WHEEL -->
      <div style="flex:1; display: flex; flex-direction: column; align-items: center;">
        <div id="wheel" style="width:320px; height:320px; border-radius:50%; border:8px solid rgba(255,255,255,0.08); box-shadow:inset 0 8px 40px rgba(0,0,0,0.8), 0 0 40px rgba(99,102,241,0.1); --win-deg:252deg; background: conic-gradient(from -90deg, #2563eb 0deg var(--win-deg), #ef4444 var(--win-deg) 360deg); transition: transform 4s cubic-bezier(.18,.9,.2,1); position: relative; display: flex; align-items: center; justify-content: center;">
          <div style="position: absolute; top: 20px; text-align: center;">
            <div style="font-size: 12px; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 1px;">Chance</div>
            <div style="font-size: 36px; font-weight: 700; color: #fef08a;" id="chanceDisplay">70.00%</div>
          </div>
        </div>
        <div id="pointer" style="width:0; height:0; border-left:18px solid transparent; border-right:18px solid transparent; border-bottom:28px solid #10b981; filter:drop-shadow(0 4px 12px rgba(0,0,0,0.8)); margin-top: -36px; z-index: 10;"></div>
        <div id="casinoResult" style="margin-top:20px; color:#cbd5e1; text-align:center; font-size: 14px; min-height: 20px;"></div>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, getDocs, addDoc, serverTimestamp, query, orderBy, limit, doc, getDoc, updateDoc, deleteDoc, increment, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCIXJyovY1P0fvoEexAApCesqiTphA_mTk",
  authDomain: "avidware.firebaseapp.com",
  projectId: "avidware",
  storageBucket: "avidware.firebasestorage.app",
  messagingSenderId: "1003506881786",
  appId: "1:1003506881786:web:8c64d2aaf477fdf009e543"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let currentThreadId = null;
let currentThreadData = null;
let isAdmin = false;

// CHECK AUTH
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    location.href = "index.html";
    return;
  }
  currentUser = user;
  document.getElementById("currentUser").textContent = user.email.split("@")[0] || user.email;
  
  // Check if admin
  try {
    const userDoc = await getDoc(doc(db, "users", user.uid));
    if (userDoc.exists()) {
      isAdmin = userDoc.data().role === "admin";
    }
  } catch (e) {
    console.error("Error checking admin:", e);
  }
  
  loadForum();
  loadChat();
  // show current coin balance immediately
  refreshCoinDisplay();
  
  // Auto-reload chat every 2 seconds
  setInterval(loadChat, 2000);
});

// ===== TAB SWITCH =====
window.switchTab = function(tab) {
  document.querySelectorAll(".tab-content").forEach(el => el.style.display = "none");
  document.querySelectorAll(".thread-view").forEach(el => el.classList.remove("active"));
  document.getElementById(tab + "-tab").style.display = "block";
  
  document.querySelectorAll(".tab-btn").forEach(el => el.classList.remove("active"));
  event.target.classList.add("active");
};

// ===== LOAD FORUM =====
async function loadForum() {
  try {
    const postsSnap = await getDocs(collection(db, "posts"));
    const topicsList = document.getElementById("topicsList");
    topicsList.innerHTML = "";

    if (postsSnap.empty) {
      topicsList.innerHTML = '<div style="color: #94a3b8; padding: 12px;">No topics yet. Create one!</div>';
    } else {
      // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≤ –∫–æ–¥–µ: –ø–∏–Ω–Ω–µ–¥ –≤–≤–µ—Ä—Ö, –ø–æ—Ç–æ–º –ø–æ –¥–∞—Ç–µ
      const posts = postsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
      posts.sort((a, b) => {
        if ((b.pinned || false) - (a.pinned || false) !== 0) {
          return (b.pinned || false) - (a.pinned || false);
        }
        const timeA = a.createdAt?.toDate?.() || new Date(0);
        const timeB = b.createdAt?.toDate?.() || new Date(0);
        return timeB - timeA;
      });
      
      for (const postData of posts) {
        const postDoc = { id: postData.id, data: () => postData };
        const post = postDoc.data();
        const date = post.createdAt ? new Date(post.createdAt.toDate()).toLocaleDateString() : "Unknown";
        const username = post.username || post.author || "Anonymous";
        const avatar = post.avatar || 'https://www.gravatar.com/avatar/?d=mp&s=48';
        
        const repliesSnap = await getDocs(collection(db, `posts/${postDoc.id}/replies`));
        const replyCount = repliesSnap.size;
        
        const pin = post.pinned ? "üìå " : "";
        const closed = post.closed ? " üîí" : "";

        topicsList.innerHTML += `
          <div class="topic" onclick="viewThread('${post.id}', '${post.title}', '${username}', '${date}')">
            <div class="topic-left">
              <img class="topic-avatar" src="${avatar}" alt="avatar">
              <div>
                <div class="topic-title">${pin}${post.title}${closed}</div>
                <div class="topic-meta">Started by ${username}</div>
              </div>
            </div>
            <div class="topic-right">
              <div class="topic-replies">${replyCount} replies</div>
              <div class="topic-date">${date}</div>
            </div>
          </div>
        `;
      }
    }
  } catch (e) {
    console.error("Load forum error:", e);
  }
}

// ===== VIEW THREAD =====
window.viewThread = async function(postId, title, author, date) {
  currentThreadId = postId;
  
  try {
    const postDoc = await getDoc(doc(db, "posts", postId));
    if (!postDoc.exists()) {
      alert("Post not found");
      return;
    }
    
    currentThreadData = postDoc.data();
    
    document.getElementById("threadTitle").textContent = title;
    document.getElementById("threadMeta").textContent = `by ${author} ‚Ä¢ ${date}`;
    
    // Show status if closed
    const statusEl = document.getElementById("threadStatus");
    if (currentThreadData.closed) {
      statusEl.textContent = "üîí This topic is closed";
    } else {
      statusEl.textContent = "";
    }
    
    // Show original post
    const originalPost = document.getElementById("originalPost");
    originalPost.innerHTML = `
      <div style="display:flex; gap:12px; align-items:center; margin-bottom:8px;">
        <img class="reply-avatar" src="${currentThreadData.avatar || 'https://www.gravatar.com/avatar/?d=mp&s=48'}" alt="avatar">
        <div style="color: #93c5fd; font-weight: 600; font-size: 12px;">${author}</div>
      </div>
      <div style="color: #cbd5e1; font-size: 13px;">${currentThreadData.content}</div>
      ${isAdmin ? `<div class="admin-controls">
        <button class="admin-btn" onclick="togglePin('${postId}')">üìå ${currentThreadData.pinned ? 'Unpin' : 'Pin'}</button>
        <button class="admin-btn" onclick="toggleClosed('${postId}')">üîí ${currentThreadData.closed ? 'Open' : 'Close'}</button>
        <button class="admin-btn" onclick="renameThread('${postId}')">‚úèÔ∏è Rename</button>
        <button class="admin-btn danger" onclick="deleteThread('${postId}')">üóëÔ∏è Delete</button>
      </div>` : ''}
    `;
    
    document.getElementById("forum-tab").style.display = "none";
    document.getElementById("thread-view").classList.add("active");
    
    await loadThreadReplies(postId);
  } catch (e) {
    console.error("Error viewing thread:", e);
    alert("Failed to load thread");
  }
};

// ===== BACK TO FORUM =====
window.backToForum = function() {
  currentThreadId = null;
  document.getElementById("forum-tab").style.display = "block";
  document.getElementById("thread-view").classList.remove("active");
  document.getElementById("replyInput").value = "";
};

// ===== LOAD THREAD REPLIES =====
async function loadThreadReplies(postId) {
  try {
    const repliesSnap = await getDocs(query(collection(db, `posts/${postId}/replies`), orderBy("createdAt", "asc")));
    const repliesContainer = document.getElementById("repliesContainer");
    repliesContainer.innerHTML = "";

    repliesSnap.forEach(replyDoc => {
      const reply = replyDoc.data();
      const username = reply.username || reply.author || "Anonymous";
      const date = reply.createdAt ? new Date(reply.createdAt.toDate()).toLocaleString() : "Unknown";
      const avatar = reply.avatar || 'https://www.gravatar.com/avatar/?d=mp&s=48';
      
      repliesContainer.innerHTML += `
        <div class="reply-item">
          <div style="display:flex; gap:8px; align-items:flex-start">
            <img class="reply-avatar" src="${avatar}" alt="avatar">
            <div style="flex:1">
              <div class="reply-author">${username}</div>
              <div class="reply-date">${date}</div>
              <div class="reply-text">${reply.text}</div>
            </div>
          </div>
        </div>
      `;
    });
  } catch (e) {
    console.error("Load replies error:", e);
  }
}

// ===== PUBLISH REPLY =====
window.publishReply = async function() {
  const input = document.getElementById("replyInput");
  const text = input.value.trim();

  if (!text) {
    alert("Reply cannot be empty");
    return;
  }

  if (!currentThreadId) return;
  
  if (currentThreadData && currentThreadData.closed && !isAdmin) {
    alert("This thread is closed");
    return;
  }

  try {
    const userDoc = await getDoc(doc(db, "users", currentUser.uid));
    const username = userDoc.exists() ? userDoc.data().username : currentUser.email.split("@")[0];

    const avatar = userDoc.exists() ? userDoc.data().avatar || null : null;

    await addDoc(collection(db, `posts/${currentThreadId}/replies`), {
      text,
      author: currentUser.email.split("@")[0],
      username,
      avatar: avatar,
      createdAt: serverTimestamp()
    });
    input.value = "";
    await loadThreadReplies(currentThreadId);
  } catch (e) {
    console.error("Publish reply error:", e);
    alert("Failed to publish reply");
  }
};

// ===== PUBLISH POST =====
window.publishPost = async () => {
  const title = document.getElementById("postTitle").value.trim();
  const content = document.getElementById("postContent").value.trim();

  if (!title || !content) {
    alert("Title and content are required");
    return;
  }

  try {
    const userDoc = await getDoc(doc(db, "users", currentUser.uid));
    const username = userDoc.exists() ? userDoc.data().username : currentUser.email.split("@")[0];

    const avatar = userDoc.exists() ? userDoc.data().avatar || null : null;

    await addDoc(collection(db, "posts"), {
      title,
      content,
      author: currentUser.email.split("@")[0],
      username,
      avatar: avatar,
      createdAt: serverTimestamp()
    });
    document.getElementById("postTitle").value = "";
    document.getElementById("postContent").value = "";
    loadForum();
  } catch (e) {
    console.error("Publish error:", e);
    alert("Failed to publish post");
  }
};

// ===== LOAD CHAT =====
async function loadChat() {
  try {
    const messagesSnap = await getDocs(collection(db, "messages"));
    const chatMessages = document.getElementById("chatMessages");
    chatMessages.innerHTML = "";

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ –≤ –∫–æ–¥–µ
    const msgs = messagesSnap.docs.map(d => d.data()).sort((a, b) => {
      const timeA = a.createdAt?.toDate?.() || new Date(0);
      const timeB = b.createdAt?.toDate?.() || new Date(0);
      return timeA - timeB;
    });
    
    msgs.forEach(msg => {
      const username = msg.username || msg.author || "Unknown";
      chatMessages.innerHTML += `
        <div class="chat-message">
          <div class="chat-message-author">${username}:</div>
          <div class="chat-message-text">${msg.text || ""}</div>
        </div>
      `;
    });

    // Auto-scroll to bottom
    chatMessages.scrollTop = chatMessages.scrollHeight;
  } catch (e) {
    console.error("Load chat error:", e);
  }
}

// ===== COINS & DAILY BONUS =====
async function refreshCoinDisplay() {
  try {
    const udoc = await getDoc(doc(db, 'users', currentUser.uid));
    const coins = udoc.exists() ? (udoc.data().avidcoin || 0) : 0;
    document.getElementById('coinBal').textContent = coins + ' ‚ß´';
  } catch (e) {
    console.error('Refresh coins error', e);
  }
}

window.claimDaily = async function() {
  try {
    const uref = doc(db, 'users', currentUser.uid);
    const udoc = await getDoc(uref);
    if (!udoc.exists()) { alert('User doc missing'); return; }
    const data = udoc.data();
    const last = data.lastDailyClaim ? data.lastDailyClaim.toDate() : new Date(0);
    const now = new Date();
    if ((now - last) < 24 * 60 * 60 * 1000) { alert('You already claimed today'); return; }
    const amount = 10; // fixed daily reward
    await updateDoc(uref, { avidcoin: increment(amount), lastDailyClaim: serverTimestamp() });
    alert('You received ' + amount + ' ‚ß´');
    refreshCoinDisplay();
  } catch (e) {
    console.error('Daily claim error', e);
    alert('Failed to claim daily');
  }
}

// ===== SHOP FUNCTIONS =====
async function loadShop() {
  try {
    const shopSnap = await getDocs(query(collection(db, 'shopItems'), orderBy('createdAt', 'desc'), limit(200)));
    const el = document.getElementById('shopList');
    el.innerHTML = '';
    shopSnap.forEach(docSnap => {
      const it = docSnap.data();
      const html = `
        <div class="topic" style="cursor:default">
          <div class="topic-left">
            <div>
              <div class="topic-title">${it.title} ‚Äî ${it.price} ‚ß´</div>
              <div class="topic-meta">Seller: ${it.sellerName || 'Unknown'}</div>
            </div>
          </div>
          <div class="topic-right">
            <button onclick="buyItem('${docSnap.id}', ${it.price}, '${it.sellerUid}')">Buy</button>
          </div>
        </div>
      `;
      el.innerHTML += html;
    });
  } catch (e) {
    console.error('Load shop error', e);
  }
}

window.createListing = async function() {
  const title = document.getElementById('itemTitle').value.trim();
  const desc = document.getElementById('itemDesc').value.trim();
  const price = parseInt(document.getElementById('itemPrice').value, 10);
  if (!title || !price || price <= 0) { alert('Title and positive price required'); return; }
  try {
    const udoc = await getDoc(doc(db, 'users', currentUser.uid));
    const sellerName = udoc.exists() ? (udoc.data().username || currentUser.email.split('@')[0]) : currentUser.email.split('@')[0];
    await addDoc(collection(db, 'shopItems'), {
      title, description: desc, price, sellerUid: currentUser.uid, sellerName, createdAt: serverTimestamp()
    });
    document.getElementById('itemTitle').value = '';
    document.getElementById('itemDesc').value = '';
    document.getElementById('itemPrice').value = '';
    loadShop();
  } catch (e) {
    console.error('Create listing error', e);
    alert('Failed to create listing');
  }
}

async function buyItem(itemId, price, sellerUid) {
  if (!confirm('Buy this item for ' + price + ' ‚ß´ ?')) return;
  try {
    const buyerRef = doc(db, 'users', currentUser.uid);
    const sellerRef = doc(db, 'users', sellerUid);
    const itemRef = doc(db, 'shopItems', itemId);
    await runTransaction(db, async (tx) => {
      const buyerDoc = await tx.get(buyerRef);
      if (!buyerDoc.exists()) throw 'Buyer doc missing';
      const buyerCoins = buyerDoc.data().avidcoin || 0;
      if (buyerCoins < price) throw 'Insufficient coins';
      const sellerDoc = await tx.get(sellerRef);
      if (!sellerDoc.exists()) throw 'Seller doc missing';
      // transfer
      tx.update(buyerRef, { avidcoin: increment(-price) });
      tx.update(sellerRef, { avidcoin: increment(price) });
      tx.delete(itemRef);
      await addDoc(collection(db, 'purchases'), { itemId, buyerUid: currentUser.uid, sellerUid, price, createdAt: serverTimestamp() });
    });
    alert('Purchase successful');
    loadShop();
    refreshCoinDisplay();
  } catch (e) {
    console.error('Buy item error', e);
    alert('Buy failed: ' + (e.message || e));
  }
}

// ===== CASINO =====
window.updateCasinoDisplay = function() {
  const bet = parseInt(document.getElementById('betAmount').value, 10) || 0;
  let chance = 70, mult = 1.2;
  if (bet <= 50) {
    chance = 70; mult = 1.2;
  } else if (bet <= 200) {
    chance = 60; mult = 1.5;
  } else {
    chance = 50; mult = 2.0;
  }
  document.getElementById('chanceDisplay').textContent = chance.toFixed(2) + '%';
  document.getElementById('multDisplay').textContent = 'x' + mult.toFixed(2);
};

window.spinCasino = async function() {
  const bet = parseInt(document.getElementById('betAmount').value, 10);
  if (!bet || bet <= 0) { alert('Enter bet'); return; }
  // Determine chance and multiplier based on bet size
  let chance = 70;
  let mult = 1.2;
  if (bet <= 50) {
    chance = 70; mult = 1.2;
  } else if (bet <= 200) {
    chance = 60; mult = 1.5;
  } else {
    chance = 50; mult = 2.0;
  }
  // Prepare visual wheel
  const wheel = document.getElementById('wheel');
  const spinBtn = document.getElementById('spinBtn');
  const resultEl = document.getElementById('casinoResult');
  const pointer = document.getElementById('pointer');
  // set CSS variable for win angle
  const winDeg = chance * 3.6; // percent -> degrees
  wheel.style.setProperty('--win-deg', winDeg + 'deg');

  // disable controls while spinning and add spinning visuals
  spinBtn.disabled = true;
  document.getElementById('betAmount').disabled = true;
  resultEl.textContent = 'Spinning...';
  wheel.classList.add('spinning');
  if (pointer) pointer.classList.add('spin-pointer');

  // compute rotation: several full spins plus random angle
  const fullSpins = 6;
  const randAngle = Math.floor(Math.random() * 360);
  const totalDeg = fullSpins * 360 + randAngle;
  // start animation
  wheel.style.transition = 'transform 4s cubic-bezier(.18,.9,.2,1)';
  wheel.style.transform = `rotate(${totalDeg}deg)`;

  // after animation ends determine result and apply transaction
  const onEnd = async () => {
    wheel.removeEventListener('transitionend', onEnd);
    // compute pointer-facing angle
    const normalized = totalDeg % 360;
    const pointerAngle = (360 - normalized) % 360; // angle at top
    const win = pointerAngle <= winDeg;
    let net = 0;
    if (win) net = Math.floor(bet * mult);
    else net = -bet;

    try {
      const userRef = doc(db, 'users', currentUser.uid);
      await runTransaction(db, async (tx) => {
        const udoc = await tx.get(userRef);
        if (!udoc.exists()) throw new Error('User doc missing');
        const coins = udoc.data().avidcoin || 0;
        if (coins < bet) throw new Error('Insufficient coins');
        // apply net change
        tx.update(userRef, { avidcoin: increment(net) });
        // record game result inside transaction
        const histRef = doc(collection(db, 'casinoHistory'));
        tx.set(histRef, { uid: currentUser.uid, bet, win, net, chance, createdAt: serverTimestamp() });
      });
      resultEl.textContent = win ? `You won ${net} ‚ß´ (chance ${chance}%)` : `You lost ${-net} ‚ß´ (chance ${chance}%)`;
    } catch (e) {
      console.error('Casino transaction error', e);
      resultEl.textContent = 'Spin failed: ' + (e.message || e);
    }

    // re-enable
    spinBtn.disabled = false;
    document.getElementById('betAmount').disabled = false;
    wheel.classList.remove('spinning');
    if (pointer) pointer.classList.remove('spin-pointer');
    refreshCoinDisplay();
    // reset wheel slowly to avoid jump next spin
    setTimeout(() => {
      wheel.style.transition = 'none';
      wheel.style.transform = 'rotate(' + (randAngle % 360) + 'deg)';
    }, 300);
  };

  wheel.addEventListener('transitionend', onEnd);
}


// ===== SEND MESSAGE =====
window.sendMessage = async () => {
  const input = document.getElementById("chatInput");
  const text = input.value.trim();

  if (!text) return;

  try {
    // Get current user's username
    const userDoc = await getDoc(doc(db, "users", currentUser.uid));
    const username = userDoc.exists() ? userDoc.data().username : currentUser.email.split("@")[0];

    await addDoc(collection(db, "messages"), {
      author: currentUser.email.split("@")[0],
      username,
      text,
      createdAt: serverTimestamp()
    });
    input.value = "";
    loadChat();
  } catch (e) {
    console.error("Send message error:", e);
    alert("Failed to send message");
  }
};

// ===== ADMIN: PIN/UNPIN =====
window.togglePin = async function(postId) {
  if (!isAdmin) return;
  try {
    await updateDoc(doc(db, "posts", postId), {
      pinned: !currentThreadData.pinned
    });
    currentThreadData.pinned = !currentThreadData.pinned;
    await viewThread(postId, currentThreadData.title, currentThreadData.username, new Date(currentThreadData.createdAt.toDate()).toLocaleDateString());
  } catch (e) {
    console.error("Error pinning:", e);
    alert("Failed to update pin status");
  }
};

// ===== ADMIN: CLOSE/OPEN =====
window.toggleClosed = async function(postId) {
  if (!isAdmin) return;
  try {
    await updateDoc(doc(db, "posts", postId), {
      closed: !currentThreadData.closed
    });
    currentThreadData.closed = !currentThreadData.closed;
    await viewThread(postId, currentThreadData.title, currentThreadData.username, new Date(currentThreadData.createdAt.toDate()).toLocaleDateString());
  } catch (e) {
    console.error("Error closing:", e);
    alert("Failed to update status");
  }
};

// ===== ADMIN: RENAME =====
window.renameThread = async function(postId) {
  if (!isAdmin) return;
  const newTitle = prompt("Enter new title:", currentThreadData.title);
  if (!newTitle) return;
  
  try {
    await updateDoc(doc(db, "posts", postId), {
      title: newTitle
    });
    currentThreadData.title = newTitle;
    document.getElementById("threadTitle").textContent = newTitle;
    loadForum();
  } catch (e) {
    console.error("Error renaming:", e);
    alert("Failed to rename thread");
  }
};

// ===== ADMIN: DELETE =====
window.deleteThread = async function(postId) {
  if (!isAdmin) return;
  if (!confirm("Are you sure you want to delete this thread and all replies?")) return;
  
  try {
    // Delete all replies
    const repliesSnap = await getDocs(collection(db, `posts/${postId}/replies`));
    for (const replyDoc of repliesSnap.docs) {
      await deleteDoc(replyDoc.ref);
    }
    
    // Delete post
    await deleteDoc(doc(db, "posts", postId));
    
    backToForum();
    loadForum();
  } catch (e) {
    console.error("Error deleting:", e);
    alert("Failed to delete thread");
  }
};

// ===== LOGOUT =====
window.logout = async () => {
  await signOut(auth);
  location.href = "index.html";
};
</script>

</body>
</html>
