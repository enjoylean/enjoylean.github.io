<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Avidware Forum</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Lexend+Giga:wght@700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #0a0415;
      color: #e5e7eb;
      font-family: Inter, Arial, sans-serif;
      min-height: 100vh;
    }

    /* TOP NAV */
    .navbar {
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid rgba(157, 78, 221, 0.2);
      padding: 12px 24px;
      display: flex;
      gap: 20px;
      align-items: center;
    }
    .navbar a, .navbar button {
      color: #cbd5e1;
      text-decoration: none;
      cursor: pointer;
      background: none;
      border: none;
      font-size: 14px;
      transition: color 0.2s;
    }
    .navbar a:hover, .navbar button:hover { color: #fff; }
    .navbar .user-info { margin-left: auto; font-size: 13px; }
    .navbar button { color: #ef4444; }

    /* CONTAINER */
    .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }

    /* TABS */
    .tabs { display: flex; gap: 12px; margin-bottom: 20px; }
    .tab-btn { padding: 8px 16px; border-radius: 6px; border: none; background: transparent; color: #cbd5e1; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s; }
    .tab-btn.active { background: linear-gradient(90deg, #8b63ff, #5b21b6); color: #fff; }

    /* FORUM CATEGORY */
    .forum-category {
      background: rgba(15, 23, 42, 0.6);
      margin-bottom: 20px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid rgba(157, 78, 221, 0.1);
      backdrop-filter: blur(4px);
    }

    .category-header {
      background: linear-gradient(90deg, #8b63ff, #5b21b6);
      color: #fff;
      padding: 12px 16px;
      font-size: 14px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .topic-list { display: flex; flex-direction: column; }

    .topic {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border-top: 1px solid rgba(157, 78, 221, 0.1);
      transition: background 0.2s;
      cursor: pointer;
    }
    .topic:hover { background: rgba(157, 78, 221, 0.08); }

    .topic-left { flex: 1; }
    .topic-title { color: #93c5fd; font-weight: 600; margin-bottom: 4px; }
    .topic-meta { color: #94a3b8; font-size: 12px; }

    .topic-right { text-align: right; font-size: 12px; color: #cbd5e1; }
    .topic-replies { color: #93c5fd; font-weight: 600; }
    .topic-date { color: #64748b; margin-top: 4px; }

    /* CREATE POST FORM */
    .create-post-section {
      background: rgba(15, 23, 42, 0.6);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
      border: 1px solid rgba(157, 78, 221, 0.1);
      backdrop-filter: blur(4px);
    }

    .section-title {
      font-size: 14px;
      font-weight: 700;
      color: #cbd5e1;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
    }

    input, textarea {
      width: 100%;
      margin-bottom: 10px;
      padding: 10px 12px;
      border-radius: 6px;
      background: rgba(2, 6, 23, 0.55);
      color: #fff;
      border: 1px solid rgba(115, 125, 150, 0.12);
      font-family: Inter, Arial, sans-serif;
    }
    input:focus, textarea:focus { outline: none; border-color: rgba(157, 78, 221, 0.8); }
    textarea { min-height: 80px; resize: vertical; }

    button { 
      padding: 10px 16px;
      background: linear-gradient(90deg, #8b63ff, #5b21b6);
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: box-shadow 0.2s;
    }
    button:hover { box-shadow: 0 6px 16px rgba(92, 33, 182, 0.3); }

    /* THREAD VIEW */
    .thread-view { display: none; }
    .thread-view.active { display: block; }

    .thread-header {
      background: rgba(15, 23, 42, 0.6);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      border: 1px solid rgba(157, 78, 221, 0.1);
    }

    .thread-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
    .thread-meta { font-size: 12px; color: #94a3b8; margin-bottom: 12px; }
    .thread-back { color: #93c5fd; cursor: pointer; text-decoration: underline; font-size: 12px; }
    
    .original-post {
      background: rgba(10, 4, 21, 0.4);
      padding: 12px;
      margin-bottom: 12px;
      border-radius: 6px;
      border-left: 3px solid rgba(157, 78, 221, 0.5);
    }

    .admin-controls {
      display: flex;
      gap: 6px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .admin-btn {
      padding: 6px 12px;
      font-size: 11px;
      background: rgba(157, 78, 221, 0.3);
      color: #93c5fd;
      border: 1px solid rgba(157, 78, 221, 0.5);
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .admin-btn:hover { background: rgba(157, 78, 221, 0.5); }

    .admin-btn.danger { background: rgba(239, 68, 68, 0.2); color: #fca5a5; border-color: rgba(239, 68, 68, 0.5); }
    .admin-btn.danger:hover { background: rgba(239, 68, 68, 0.3); }

    .replies-container {
      background: rgba(15, 23, 42, 0.6);
      border-radius: 8px;
      padding: 16px;
      border: 1px solid rgba(157, 78, 221, 0.1);
      margin-bottom: 16px;
    }

    .reply-item {
      background: rgba(10, 4, 21, 0.4);
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 6px;
      border-left: 3px solid rgba(157, 78, 221, 0.5);
    }

    .reply-author { color: #93c5fd; font-weight: 600; font-size: 12px; margin-bottom: 4px; }
    .reply-date { color: #64748b; font-size: 11px; margin-bottom: 6px; }
    .reply-text { color: #cbd5e1; font-size: 13px; }

    .reply-form {
      background: rgba(15, 23, 42, 0.6);
      border-radius: 8px;
      padding: 16px;
      border: 1px solid rgba(157, 78, 221, 0.1);
    }

    .reply-form-title { font-size: 12px; font-weight: 700; text-transform: uppercase; margin-bottom: 12px; }
    .reply-input-group { display: flex; gap: 8px; }
    .reply-input-group input { flex: 1; }

    /* CHAT */
    .chat-box {
      background: rgba(15, 23, 42, 0.6);
      border-radius: 8px;
      padding: 16px;
      border: 1px solid rgba(157, 78, 221, 0.1);
      height: 500px;
      display: flex;
      flex-direction: column;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .chat-message {
      background: rgba(10, 4, 21, 0.4);
      padding: 8px 12px;
      border-radius: 6px;
      border-left: 2px solid rgba(157, 78, 221, 0.5);
      font-size: 12px;
    }

    .chat-message-author { color: #93c5fd; font-weight: 600; font-size: 11px; }
    .chat-message-text { color: #cbd5e1; margin-top: 2px; }

    .chat-input-group { display: flex; gap: 8px; }
    .chat-input-group input { flex: 1; }

    @media (max-width: 768px) {
      .topic { flex-direction: column; align-items: flex-start; }
      .topic-right { margin-top: 8px; }
    }
  </style>
</head>
<body>

<!-- NAVBAR -->
<div class="navbar">
  <a href="index.html">Index</a>
  <a href="#">Search</a>
  <a href="profile.html">Profile</a>
  <a href="#">PM</a>
  <div class="user-info">
    Logged in as: <span id="currentUser">User</span>
  </div>
  <button onclick="logout()">Logout</button>
</div>

<div class="container">
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('forum')">Forum</button>
    <button class="tab-btn" onclick="switchTab('chat')">Chat</button>
  </div>

  <!-- FORUM TAB -->
  <div id="forum-tab" class="tab-content">
    <!-- CREATE POST -->
    <div class="create-post-section">
      <div class="section-title">Create New Topic</div>
      <input id="postTitle" placeholder="Topic title...">
      <textarea id="postContent" placeholder="Write your message..."></textarea>
      <button onclick="publishPost()">Create Topic</button>
    </div>

    <!-- FORUM CATEGORIES -->
    <div class="forum-category">
      <div class="category-header">General Discussion</div>
      <div class="topic-list" id="topicsList"></div>
    </div>
  </div>

  <!-- THREAD VIEW -->
  <div id="thread-view" class="thread-view">
    <div class="thread-header">
      <div class="thread-back" onclick="backToForum()">‚Üê Back to Forum</div>
      <div class="thread-title" id="threadTitle"></div>
      <div class="thread-meta" id="threadMeta"></div>
      <div id="threadStatus" style="margin-top: 8px; font-size: 11px; color: #fca5a5;"></div>
    </div>

    <div class="original-post" id="originalPost"></div>

    <div class="replies-container" id="repliesContainer"></div>

    <div class="reply-form">
      <div class="reply-form-title">Write a Reply</div>
      <div class="reply-input-group">
        <input id="replyInput" placeholder="Write your reply...">
        <button onclick="publishReply()">Post Reply</button>
      </div>
    </div>
  </div>

  <!-- CHAT TAB -->
  <div id="chat-tab" class="tab-content" style="display: none;">
    <div class="chat-box">
      <div class="section-title" style="margin-bottom: 12px;">üí¨ Live Chat</div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input-group">
        <input id="chatInput" placeholder="Type a message...">
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, getDocs, addDoc, serverTimestamp, query, orderBy, limit, doc, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCIXJyovY1P0fvoEexAApCesqiTphA_mTk",
  authDomain: "avidware.firebaseapp.com",
  projectId: "avidware",
  storageBucket: "avidware.firebasestorage.app",
  messagingSenderId: "1003506881786",
  appId: "1:1003506881786:web:8c64d2aaf477fdf009e543"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let currentThreadId = null;
let currentThreadData = null;
let isAdmin = false;

// CHECK AUTH
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    location.href = "index.html";
    return;
  }
  currentUser = user;
  document.getElementById("currentUser").textContent = user.email.split("@")[0] || user.email;
  
  // Check if admin
  try {
    const userDoc = await getDoc(doc(db, "users", user.uid));
    if (userDoc.exists()) {
      isAdmin = userDoc.data().role === "admin";
    }
  } catch (e) {
    console.error("Error checking admin:", e);
  }
  
  loadForum();
  loadChat();
  
  // Auto-reload chat every 2 seconds
  setInterval(loadChat, 2000);
});

// ===== TAB SWITCH =====
window.switchTab = function(tab) {
  document.querySelectorAll(".tab-content").forEach(el => el.style.display = "none");
  document.querySelectorAll(".thread-view").forEach(el => el.classList.remove("active"));
  document.getElementById(tab + "-tab").style.display = "block";
  
  document.querySelectorAll(".tab-btn").forEach(el => el.classList.remove("active"));
  event.target.classList.add("active");
};

// ===== LOAD FORUM =====
async function loadForum() {
  try {
    const postsSnap = await getDocs(collection(db, "posts"));
    const topicsList = document.getElementById("topicsList");
    topicsList.innerHTML = "";

    if (postsSnap.empty) {
      topicsList.innerHTML = '<div style="color: #94a3b8; padding: 12px;">No topics yet. Create one!</div>';
    } else {
      // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≤ –∫–æ–¥–µ: –ø–∏–Ω–Ω–µ–¥ –≤–≤–µ—Ä—Ö, –ø–æ—Ç–æ–º –ø–æ –¥–∞—Ç–µ
      const posts = postsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
      posts.sort((a, b) => {
        if ((b.pinned || false) - (a.pinned || false) !== 0) {
          return (b.pinned || false) - (a.pinned || false);
        }
        const timeA = a.createdAt?.toDate?.() || new Date(0);
        const timeB = b.createdAt?.toDate?.() || new Date(0);
        return timeB - timeA;
      });
      
      for (const postData of posts) {
        const postDoc = { id: postData.id, data: () => postData };
        const post = postDoc.data();
        const date = post.createdAt ? new Date(post.createdAt.toDate()).toLocaleDateString() : "Unknown";
        const username = post.username || post.author || "Anonymous";
        
        const repliesSnap = await getDocs(collection(db, `posts/${postDoc.id}/replies`));
        const replyCount = repliesSnap.size;
        
        const pin = post.pinned ? "üìå " : "";
        const closed = post.closed ? " üîí" : "";

        topicsList.innerHTML += `
          <div class="topic" onclick="viewThread('${post.id}', '${post.title}', '${username}', '${date}')">
            <div class="topic-left">
              <div class="topic-title">${pin}${post.title}${closed}</div>
              <div class="topic-meta">Started by ${username}</div>
            </div>
            <div class="topic-right">
              <div class="topic-replies">${replyCount} replies</div>
              <div class="topic-date">${date}</div>
            </div>
          </div>
        `;
      }
    }
  } catch (e) {
    console.error("Load forum error:", e);
  }
}

// ===== VIEW THREAD =====
window.viewThread = async function(postId, title, author, date) {
  currentThreadId = postId;
  
  try {
    const postDoc = await getDoc(doc(db, "posts", postId));
    if (!postDoc.exists()) {
      alert("Post not found");
      return;
    }
    
    currentThreadData = postDoc.data();
    
    document.getElementById("threadTitle").textContent = title;
    document.getElementById("threadMeta").textContent = `by ${author} ‚Ä¢ ${date}`;
    
    // Show status if closed
    const statusEl = document.getElementById("threadStatus");
    if (currentThreadData.closed) {
      statusEl.textContent = "üîí This topic is closed";
    } else {
      statusEl.textContent = "";
    }
    
    // Show original post
    const originalPost = document.getElementById("originalPost");
    originalPost.innerHTML = `
      <div style="color: #93c5fd; font-weight: 600; font-size: 12px; margin-bottom: 4px;">${author}</div>
      <div style="color: #cbd5e1; font-size: 13px;">${currentThreadData.content}</div>
      ${isAdmin ? `<div class="admin-controls">
        <button class="admin-btn" onclick="togglePin('${postId}')">üìå ${currentThreadData.pinned ? 'Unpin' : 'Pin'}</button>
        <button class="admin-btn" onclick="toggleClosed('${postId}')">üîí ${currentThreadData.closed ? 'Open' : 'Close'}</button>
        <button class="admin-btn" onclick="renameThread('${postId}')">‚úèÔ∏è Rename</button>
        <button class="admin-btn danger" onclick="deleteThread('${postId}')">üóëÔ∏è Delete</button>
      </div>` : ''}
    `;
    
    document.getElementById("forum-tab").style.display = "none";
    document.getElementById("thread-view").classList.add("active");
    
    await loadThreadReplies(postId);
  } catch (e) {
    console.error("Error viewing thread:", e);
    alert("Failed to load thread");
  }
};

// ===== BACK TO FORUM =====
window.backToForum = function() {
  currentThreadId = null;
  document.getElementById("forum-tab").style.display = "block";
  document.getElementById("thread-view").classList.remove("active");
  document.getElementById("replyInput").value = "";
};

// ===== LOAD THREAD REPLIES =====
async function loadThreadReplies(postId) {
  try {
    const repliesSnap = await getDocs(query(collection(db, `posts/${postId}/replies`), orderBy("createdAt", "asc")));
    const repliesContainer = document.getElementById("repliesContainer");
    repliesContainer.innerHTML = "";

    repliesSnap.forEach(replyDoc => {
      const reply = replyDoc.data();
      const username = reply.username || reply.author || "Anonymous";
      const date = reply.createdAt ? new Date(reply.createdAt.toDate()).toLocaleString() : "Unknown";
      
      repliesContainer.innerHTML += `
        <div class="reply-item">
          <div class="reply-author">${username}</div>
          <div class="reply-date">${date}</div>
          <div class="reply-text">${reply.text}</div>
        </div>
      `;
    });
  } catch (e) {
    console.error("Load replies error:", e);
  }
}

// ===== PUBLISH REPLY =====
window.publishReply = async function() {
  const input = document.getElementById("replyInput");
  const text = input.value.trim();

  if (!text) {
    alert("Reply cannot be empty");
    return;
  }

  if (!currentThreadId) return;
  
  if (currentThreadData && currentThreadData.closed && !isAdmin) {
    alert("This thread is closed");
    return;
  }

  try {
    const userDoc = await getDoc(doc(db, "users", currentUser.uid));
    const username = userDoc.exists() ? userDoc.data().username : currentUser.email.split("@")[0];

    await addDoc(collection(db, `posts/${currentThreadId}/replies`), {
      text,
      author: currentUser.email.split("@")[0],
      username,
      createdAt: serverTimestamp()
    });
    input.value = "";
    await loadThreadReplies(currentThreadId);
  } catch (e) {
    console.error("Publish reply error:", e);
    alert("Failed to publish reply");
  }
};

// ===== PUBLISH POST =====
window.publishPost = async () => {
  const title = document.getElementById("postTitle").value.trim();
  const content = document.getElementById("postContent").value.trim();

  if (!title || !content) {
    alert("Title and content are required");
    return;
  }

  try {
    const userDoc = await getDoc(doc(db, "users", currentUser.uid));
    const username = userDoc.exists() ? userDoc.data().username : currentUser.email.split("@")[0];

    await addDoc(collection(db, "posts"), {
      title,
      content,
      author: currentUser.email.split("@")[0],
      username,
      createdAt: serverTimestamp()
    });
    document.getElementById("postTitle").value = "";
    document.getElementById("postContent").value = "";
    loadForum();
  } catch (e) {
    console.error("Publish error:", e);
    alert("Failed to publish post");
  }
};

// ===== LOAD CHAT =====
async function loadChat() {
  try {
    const messagesSnap = await getDocs(collection(db, "messages"));
    const chatMessages = document.getElementById("chatMessages");
    chatMessages.innerHTML = "";

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ –≤ –∫–æ–¥–µ
    const msgs = messagesSnap.docs.map(d => d.data()).sort((a, b) => {
      const timeA = a.createdAt?.toDate?.() || new Date(0);
      const timeB = b.createdAt?.toDate?.() || new Date(0);
      return timeA - timeB;
    });
    
    msgs.forEach(msg => {
      const username = msg.username || msg.author || "Unknown";
      chatMessages.innerHTML += `
        <div class="chat-message">
          <div class="chat-message-author">${username}:</div>
          <div class="chat-message-text">${msg.text || ""}</div>
        </div>
      `;
    });

    // Auto-scroll to bottom
    chatMessages.scrollTop = chatMessages.scrollHeight;
  } catch (e) {
    console.error("Load chat error:", e);
  }
}

// ===== SEND MESSAGE =====
window.sendMessage = async () => {
  const input = document.getElementById("chatInput");
  const text = input.value.trim();

  if (!text) return;

  try {
    // Get current user's username
    const userDoc = await getDoc(doc(db, "users", currentUser.uid));
    const username = userDoc.exists() ? userDoc.data().username : currentUser.email.split("@")[0];

    await addDoc(collection(db, "messages"), {
      author: currentUser.email.split("@")[0],
      username,
      text,
      createdAt: serverTimestamp()
    });
    input.value = "";
    loadChat();
  } catch (e) {
    console.error("Send message error:", e);
    alert("Failed to send message");
  }
};

// ===== ADMIN: PIN/UNPIN =====
window.togglePin = async function(postId) {
  if (!isAdmin) return;
  try {
    await updateDoc(doc(db, "posts", postId), {
      pinned: !currentThreadData.pinned
    });
    currentThreadData.pinned = !currentThreadData.pinned;
    await viewThread(postId, currentThreadData.title, currentThreadData.username, new Date(currentThreadData.createdAt.toDate()).toLocaleDateString());
  } catch (e) {
    console.error("Error pinning:", e);
    alert("Failed to update pin status");
  }
};

// ===== ADMIN: CLOSE/OPEN =====
window.toggleClosed = async function(postId) {
  if (!isAdmin) return;
  try {
    await updateDoc(doc(db, "posts", postId), {
      closed: !currentThreadData.closed
    });
    currentThreadData.closed = !currentThreadData.closed;
    await viewThread(postId, currentThreadData.title, currentThreadData.username, new Date(currentThreadData.createdAt.toDate()).toLocaleDateString());
  } catch (e) {
    console.error("Error closing:", e);
    alert("Failed to update status");
  }
};

// ===== ADMIN: RENAME =====
window.renameThread = async function(postId) {
  if (!isAdmin) return;
  const newTitle = prompt("Enter new title:", currentThreadData.title);
  if (!newTitle) return;
  
  try {
    await updateDoc(doc(db, "posts", postId), {
      title: newTitle
    });
    currentThreadData.title = newTitle;
    document.getElementById("threadTitle").textContent = newTitle;
    loadForum();
  } catch (e) {
    console.error("Error renaming:", e);
    alert("Failed to rename thread");
  }
};

// ===== ADMIN: DELETE =====
window.deleteThread = async function(postId) {
  if (!isAdmin) return;
  if (!confirm("Are you sure you want to delete this thread and all replies?")) return;
  
  try {
    // Delete all replies
    const repliesSnap = await getDocs(collection(db, `posts/${postId}/replies`));
    for (const replyDoc of repliesSnap.docs) {
      await deleteDoc(replyDoc.ref);
    }
    
    // Delete post
    await deleteDoc(doc(db, "posts", postId));
    
    backToForum();
    loadForum();
  } catch (e) {
    console.error("Error deleting:", e);
    alert("Failed to delete thread");
  }
};

// ===== LOGOUT =====
window.logout = async () => {
  await signOut(auth);
  location.href = "index.html";
};
</script>

</body>
</html>
